<?php

// $Id$

/**
 * @file 
 */

/**
 * Implementation of hook_menu()
 */
function terminal_menu() {
  $items = array();
  $items['terminal/input'] = array(
    'title' => 'Terminal AJAX Callback',
    'page callback' => 'terminal_ajax_callback',
    'access arguments' => array('access terminal'),
    'type' => MENU_CALLBACK,
  );

  $items['terminal/state'] = array(
    'title' => 'State callback',
    'page callback' => 'terminal_state_callback',
    'access arguments' => array('access terminal'),
    'type' => MENU_CALLBACK,
  );

  return $items;
}

/**
 * Implementation of hook_perm()
 */
function terminal_perm() {
  return array('access terminal');
}

/**
 * Terminal textarea
 */
function terminal_form() {
  $form = array();
  return $form;
}

/**
 * Implementation of hook_init()
 */
function terminal_init() {
  if (user_access('access terminal')) {
  drupal_add_js(drupal_get_path('module', 'terminal') .'/terminal.js');
  drupal_add_js(drupal_get_path('module', 'terminal') .'/jquery.terminal.js');
  drupal_add_css(drupal_get_path('module', 'terminal') .'/terminal.css');
  global $user;
  $host = $_SERVER['host'];
  $settings = array(
    'user' => $user->name,
    'host' => $host,
    'sitename' => variable_get('site_name', ''),
  );
  drupal_add_js($settings, 'setting');
  }
}

/**
 * Set/get the terminal visibility state
 */
function terminal_state_callback($state = NULL) {
  // Yes I know, per-user. Also not sure if its safe.
  if (isset($state)) {
    variable_set('terminal_state', $state);
  }
  else {
    print variable_get('terminal_state', 'visible');
  }
}

function terminal_ajax_callback() {
  $input = $_POST['input'];
  terminal_log_history($input);

  $args = explode(" ", $input);
  $command = array_shift($args);
  if (function_exists('terminal_'. $command)) {
    call_user_func('terminal_'. $command, $args);
  }
  else {
    print t('Invalid command');
  }

  exit;
}

function terminal_nodedel($args) {
  $nid = $args[0];
  $node = node_load($nid);
  node_delete($nid);
  print t('Node @title deleted', array('@title' => $node->title));
}

function terminal_goto($args) {
  $path = $args[0];
  print $path;
}

function terminal_adduser($args) {
}

function terminal_log_history($input) {
  global $user;
  db_query('INSERT INTO {terminal_history} (uid, input) VALUES (%d, "%s")', $input, $user->uid);
}
